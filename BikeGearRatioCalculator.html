
<!DOCTYPE html>
<html lang="en">

   <head>
      <title>Bike Gear Ratio Calculator</title>
      <meta name="description" content="Bike Calculator: Computes optimal development / gear ratio for a realistic power model.  Includes incline, rolling resistance and drag.">
      <meta name="viewport" content="width=device-width, initial-scale=1">
      <meta charset="utf-8">
      <meta name="author" content="Kevin Dusling" />
      <meta NAME="ROBOTS" CONTENT="INDEX, FOLLOW">

      <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
      <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>
      <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>

      <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">

     <script type="text/x-mathjax-config">
       MathJax.Hub.Config({tex2jax: {inlineMath: [['$','$'], ['\\(','\\)']]}});
     </script>

     <script type="text/javascript" async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.2/MathJax.js?config=TeX-MML-AM_CHTML">
 </script>


<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-7080617284731198"
     crossorigin="anonymous"></script>
	 
	 <!--<link rel="stylesheet" href="styles/BikePowerStyle.css">-->
	 
	 <script src='https://cdn.plot.ly/plotly-3.3.0.min.js'></script>

</head>





  <script type="text/javascript">

  var units = "metric";

window.onload = function() {

  const params = new URLSearchParams(window.location.search);

  if ( params.has('units') )
  {
    var units = params.get('units');
    document.getElementById(units).checked = true;
    ChangeUnits(  document.getElementById(units) );
  }

  if ( params.has('RiderWeight') )
  {
    document.getElementById("rider_weight").value =  params.get('RiderWeight');
  }
  if ( params.has('BikeWeight') )
  {
    document.getElementById("bike_weight").value =  params.get('BikeWeight');
  }

  if ( params.has('CdA') )
  {
    document.getElementById("CdA").value =  params.get('CdA');
  }

  if ( params.has('Crr') )
  {
    document.getElementById("Crr").value =  params.get('Crr');
  }

  if ( params.has('eff') )
  {
    document.getElementById("eta").value =  params.get('eff');
  }

  if ( params.has('grade') )
  {
    document.getElementById("grade").value =  params.get('grade');
  }

  if ( params.has('pmax') )
  {
    document.getElementById("pmax").value =  params.get('pmax');
  }

  if ( params.has('PRopt') )
  {
    document.getElementById("PRopt").value =  params.get('PRopt');
  }
  
  if ( params.has('circ') )
  {
    document.getElementById("circ").value =  params.get('circ');
  }
  
  const wheeldata = [
    { text: "700x18C / 18-622", value: "2.070" },
    { text: "700x19C / 19-622", value: "2.080" },
    { text: "700x20C / 20-622", value: "2.086" },
	{ text: "700x23C / 23-622", value: "2.096" },
	{ text: "700x25C / 25-622", value: "2.105" },
    { text: "700x28C / 28-622", value: "2.136" },
    { text: "700x30C / 30-622", value: "2.146" },
	{ text: "700x32C / 32-622", value: "2.155" },
    { text: "700x35C / 35-622", value: "2.168" },
    { text: "700x38C / 38-622", value: "2.180" },
	{ text: "700x40C / 40-622", value: "2.200" },
	];

  
  const dropdown = document.getElementById("wheel-list");
  
  wheeldata.forEach(item => {
  dropdown.innerHTML += "<a class='dropdown-item' href='javascript:void(0)' onclick='document.getElementById(\"circ\").value=\"" + item.value + "\";'>" + item.text + "</a>";
  });
  
  UpdateAll();

}; //end window.onload

function createURL()
{
var url = "https://kdusling.github.io/BikeGearRatioCalculator.html?units=" + units;
     url += "&RiderWeight=" + document.getElementById("rider_weight").value;
     url += "&BikeWeight=" + document.getElementById("bike_weight").value;
     url += "&CdA=" + document.getElementById("CdA").value;
     url += "&Crr=" + document.getElementById("Crr").value;
     url += "&eff=" + document.getElementById("eta").value;
     url += "&grade=" + document.getElementById("grade").value;
     url += "&pmax=" + document.getElementById("pmax").value;
     url += "&PRopt=" + document.getElementById("PRopt").value;
	 url += "&circ=" + document.getElementById("circ").value;

navigator.clipboard.writeText(url);
}



function findMin(f,a,b,aux)
{

 var err = 1.e-10;
 var ep = 1.e-3;

 do {
 
		var mid = (a+b)/2;

		var deriv = (f(mid + ep) - f(mid - ep)) / (2 * ep)
 
		if (deriv > 0) {
			b = mid;
		} else {
			a = mid;
		}

    } while( b-a >err );


return (a+b)/2;
} 



function makePlotVinf() {

	var CdA = document.getElementById("CdA").value;
	var Crr = document.getElementById("Crr").value;
	var eta = document.getElementById("eta").value/100.0;
	var mass = parseFloat(document.getElementById("bike_weight").value) + parseFloat(document.getElementById("rider_weight").value);
	var angle = Math.atan(parseFloat(document.getElementById("grade").value)/100.);
	var pmax = parseFloat(document.getElementById("pmax").value);
	var PRopt = parseFloat(document.getElementById("PRopt").value);
	var circ = parseFloat(document.getElementById("circ").value);
	
	if (units === "imperial"){
		mass = mass/2.205;
		CdA = CdA/3.28084**2;
		circ = circ/39.3701;
	}
  
	var g = 9.81;
	var rho = 1.225;
	var cd = 1/(2*mass)*rho*CdA;
	var gs = Crr*g*Math.cos(angle)+g*Math.sin(angle);
	
	var Dmax = 2*pmax*60/PRopt/mass/gs;
	var DoptInf = 60/PRopt*Math.sqrt(4*gs/3/cd)*Math.sinh(1/3*Math.asinh(Math.sqrt(27*cd*pmax**2/(4*mass**2*gs**3))));
	
	var footer = document.getElementById("tab-footer");
	footer.innerHTML = '';
	var rowfoot = footer.insertRow(0);
	rowfoot.className  = "table-info"
	var cellfoot = rowfoot.insertCell(0);
	cellfoot.colSpan = "4";

	cellfoot.innerHTML = "For endurance efforts the optimum developement is " + DoptInf.toFixed(2) + "m corresponding to a gear ratio of " + (DoptInf/circ).toFixed(2)+" and a resulting speed of " + (3.6*vinf(DoptInf)).toFixed(2) + " kph (" + (0.621371*3.6*vinf(DoptInf)).toFixed(2) + " mph).";
	
  
	function vinf(D) {
		var vopt = D/60*PRopt;
		var vbar = eta*pmax/(2*mass*cd*vopt**2)
		var vinf = Math.sqrt( vbar**2 + 4*vbar*vopt - gs/cd ) - vbar;
		return vinf;
	}
	


	var yaxis_label = "kph";
    
	if (units === "imperial"){
      yaxis_label = "mph";
	} 

    // 2. Generate the x and y coordinates
	const x_values = [];
	const y_values = [];
	const PR_values = [];
	const pow_values = [];
	const start_x = 0;
	const end_x = Dmax/circ;
	const step_size = end_x/1000;

	
	for (let x = start_x; x <= end_x; x += step_size) {
		var D = x*circ;
		var myvinf = vinf(D);
		var PR = 60.*myvinf/D;
		x_values.push(x);
		y_values.push( (units === "metric" ? 3.6*myvinf : 0.621371*3.6*myvinf ) );
		PR_values.push( PR );
		pow_values.push( pmax*( 2*PR/PRopt - (PR/PRopt)**2 ) );
	}
	
	const customDataCombined = PR_values.map((d1, i) => [d1, pow_values[i]]);


	const trace = {
		x: x_values,
		y: y_values,
		customdata: customDataCombined,
		hovertemplate: 'gear ratio: %{x:.2f}<br>' +
                        'v= %{y:.2f} ' + yaxis_label + '<br>' +
                        'rpm= %{customdata[0]:.2f}<br>' +
						'power= %{customdata[1]:.2f} W',
		mode: 'lines',
		type: 'scatter',
		name: ''
	};

	
	var layout = {
        xaxis: {
			title: {
				text: 'Gear Ratio', 
				font: {size: 18}
			}
		},
		yaxis: {
			title: {
				text: yaxis_label,
				font: {size: 18}
			}
		},
		height: 400, 
		width: 600, 
	};

	Plotly.newPlot('vinf-plot-div', [trace], layout);
	
}


function makePlotDopt() {

	var CdA = document.getElementById("CdA").value;
	var Crr = document.getElementById("Crr").value;
	var eta = document.getElementById("eta").value/100.0;
	var mass = parseFloat(document.getElementById("bike_weight").value) + parseFloat(document.getElementById("rider_weight").value);
	var angle = Math.atan(parseFloat(document.getElementById("grade").value)/100.);
	var pmax = parseFloat(document.getElementById("pmax").value);
	var PRopt = parseFloat(document.getElementById("PRopt").value);
	var circ = parseFloat(document.getElementById("circ").value);
	
	if (units === "imperial"){
		mass = mass/2.205;
		CdA = CdA/3.28084**2;
		circ = circ/39.3701;
	}
  
	var g = 9.81;
	var rho = 1.225;
	var cd = 1/(2*mass)*rho*CdA;
	var gs = Crr*g*Math.cos(angle)+g*Math.sin(angle);
	
	var Dmax = 2*pmax*60/PRopt/mass/gs;
	var DoptInf = 60/PRopt*Math.sqrt(4*gs/3/cd)*Math.sinh(1/3*Math.asinh(Math.sqrt(27*cd*pmax**2/(4*mass**2*gs**3))));
  
	function tfinal(D,x) {
		var vopt = D/60*PRopt;
		var vbar = eta*pmax/(2*mass*cd*vopt**2)
		var vinf = Math.sqrt( vbar**2 + 4*vbar*vopt - gs/cd ) - vbar;
		return x/vinf + 1/(cd*vinf)*Math.log(2*(vinf+vbar)/(vinf+2*vbar));
	}
	
	

	var xaxis_label = "distance (m)";
    
	if (units === "imperial"){
      xaxis_label = "distance (feet)";
	} 

    // 2. Generate the x and y coordinates
	const x_values = [];
	const y_values = [];
	const time_values = [];
	const distance_values = [];
	const start_x = 2;
	const end_x = (units==="imperial" ? 6 : 5);
	
	const step_size = end_x/1000;
		
	for (let x = start_x; x <= end_x; x += step_size) {
		dist = 10**x;
		var dopt = findMin(D => tfinal(D,dist) ,0.1, Dmax);
		x_values.push( dist );
		y_values.push( dopt/circ );
		y_values.push( dopt/circ );

		time_values.push( new Date(tfinal(dopt,dist)*1000).toISOString().substring(11, 19)  );
		if (units === "metric"){
			distance_values.push( dist > 999 ? (dist / 1000).toFixed(1) + 'km' : dist.toFixed(0) + 'm');
		}
		if (units === "imperial"){
			distance_values.push( dist > 5280 ? (dist / 5280).toFixed(1) + 'mi' : dist.toFixed(0) + ' ft' );
		}
	}


	var table = document.getElementById("tab-results");	
	table.innerHTML = '';
	tabdist = [250,500,750,1500,4000,10000,50000];
	for (let i = 0; i<6; i++) {
		dist = tabdist[i]
		var dopt = findMin(D => tfinal(D,dist) ,0.1, Dmax);
		var time = tfinal(dopt,dist);
		
		var row = table.insertRow(-1);
		var cell = row.insertCell(-1);
	    cell.innerHTML = ( dist > 999 ? (dist / 1000).toFixed(1) + ' km' : dist.toFixed(0) + ' m');
		cell = row.insertCell(-1);
	    cell.innerHTML = dopt.toFixed(2);
		cell = row.insertCell(-1);
	    cell.innerHTML = (dopt/circ).toFixed(2);
		cell = row.insertCell(-1);
	    cell.innerHTML = new Date(time*1000).toISOString().substring(11, 19);
	}
	
	
	const customDataCombined = time_values.map((d1, i) => [d1, distance_values[i]]);


	const trace = {
		x: x_values,
		y: y_values,
		customdata: customDataCombined,
		hovertemplate: 'distance: %{customdata[1]}<br>' +
                        'gear ratio= %{y:.2f}<br>' +
                        'time= %{customdata[0]}<br>',
		mode: 'lines',
		type: 'scatter',
		name: ''
	};

	
	var layout = {
        xaxis: {
			title: {
				text: xaxis_label, 
				font: {size: 18}
			},
			type: 'log',
		},
		yaxis: {
			title: {
				text: 'Gear Ratio',
				font: {size: 18}
			}
		},
		height: 400, 
		width: 600, 
	};

	Plotly.newPlot('dopt-plot-div', [trace], layout);
	
}

function ChangeUnits(myRadio){
   units = myRadio.value;

   if (units === "metric"){
     document.getElementById("weight_unit").textContent="kg";
     document.getElementById("rider_weight").value = ((document.getElementById("rider_weight").value)/2.205).toFixed(0);

     document.getElementById("weight_unit2").textContent="kg";
     document.getElementById("bike_weight").value = ((document.getElementById("bike_weight").value)/2.205).toFixed(0);

     document.getElementById("CdA_unit").textContent="m$^2$";
     MathJax.Hub.Queue(["Typeset",MathJax.Hub,"CdA_unit"]);
     document.getElementById("CdA").value = ((document.getElementById("CdA").value)/3.28084/3.28084).toPrecision(3);

     document.getElementById("wheel_unit").textContent="m";
     document.getElementById("circ").value = ((document.getElementById("circ").value)/39.3701).toFixed(3);

   }

   if (units === "imperial"){
     document.getElementById("weight_unit").textContent="lb";
     document.getElementById("rider_weight").value = ((document.getElementById("rider_weight").value)*2.205).toFixed(0);

     document.getElementById("weight_unit2").textContent="lb";
     document.getElementById("bike_weight").value = ((document.getElementById("bike_weight").value)*2.205).toFixed(0);

     document.getElementById("CdA_unit").textContent="ft$^2$";
     MathJax.Hub.Queue(["Typeset",MathJax.Hub,"CdA_unit"]);
     document.getElementById("CdA").value = ((document.getElementById("CdA").value)*3.28084*3.28084).toPrecision(3);

     document.getElementById("wheel_unit").textContent="inches";
     document.getElementById("circ").value = ((document.getElementById("circ").value)*39.3701).toFixed(1);
	 

   }

}

function UpdateAll() {
 makePlotVinf();
 makePlotDopt();
}

</script>


<body>
  <div class="border p-3" class="container-fluid">
  <div  class="col-xs-12 col-md-8" >

        <div class="form-row align-items-center">
        <legend class="col-form-label col-sm-2 pt-0">Units</legend>
        
		<div class="col-sm-4">
		  
		<div class="form-check form-check-inline">
          <input class="form-check-input" type="radio" name="units" id="metric" onchange="ChangeUnits(this);UpdateAll();" value="metric" checked>
          <label class="form-check-label" for="metric">metric</label>
        </div>
		  
        <div class="form-check form-check-inline">
          <input class="form-check-input" type="radio" name="units" id="imperial" onchange="ChangeUnits(this);UpdateAll();" value="imperial" >
          <label class="form-check-label" for="imperial">imperial</label>
        </div>
          
        </div>
		
		<span>Save url to clipboard:</span>
        <button type="button" class="btn btn-outline-primary m-3" data-toggle="tooltip" data-placement="bottom" title="Copy custom url to clipboard" onclick="createURL();">
        <svg class="icon" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" width="24" height="24" viewBox="0 0 24 24"><path d="M17,9H7V7H17M17,13H7V11H17M14,17H7V15H14M12,3A1,1 0 0,1 13,4A1,1 0 0,1 12,5A1,1 0 0,1 11,4A1,1 0 0,1 12,3M19,3H14.82C14.4,1.84 13.3,1 12,1C10.7,1 9.6,1.84 9.18,3H5A2,2 0 0,0 3,5V19A2,2 0 0,0 5,21H19A2,2 0 0,0 21,19V5A2,2 0 0,0 19,3Z" /></svg>
        </button>

		
		</div> <!--end div for form-row-->
		
		

      <div class="input-group mb-3">
      <div class="input-group-prepend">
      <span class="input-group-text">Rider Weight</span>
      </div>
      <input type="text" class="form-control" id="rider_weight" aria-label="Rider Weight" value="81" onchange="UpdateAll();">
      <div class="input-group-append">
      <span class="input-group-text" id="weight_unit">kg</span>
      </div>
      </div>

      <div class="input-group mb-3">
      <div class="input-group-prepend">
      <span class="input-group-text">Bike Weight</span>
      </div>
      <input type="text" class="form-control" id="bike_weight" aria-label="Bike Weight" value="14" onchange="UpdateAll();">
      <div class="input-group-append">
      <span class="input-group-text" id="weight_unit2">kg</span>
      </div>
      </div>

      <div class="input-group mb-3">
      <div class="input-group-prepend">
      <span class="input-group-text">Drag Area</span>
      </div>
      <input type="text" class="form-control" id="CdA" aria-label="CdA" value="0.40" onchange="UpdateAll();">
      <div class="input-group-append">
      <span class="input-group-text" id="CdA_unit">m$^2$</span>
      </div>
      </div>

      <div class="input-group mb-3">
      <div class="input-group-prepend">
      <span class="input-group-text">$C_{rr}$</span>

      </div>
      <input type="text" class="form-control" id="Crr" aria-label="Crr" value="0.0045" onchange="UpdateAll();" >
      </div>

      <div class="input-group mb-3">
      <div class="input-group-prepend">
      <span class="input-group-text" >Drivetrain Efficiency</span>
      </div>
      <input type="text" class="form-control" id="eta" aria-label="eta" value="100"  onchange="UpdateAll();" >
      <div class="input-group-append">
      <span class="input-group-text" id="">%</span>
      </div>
      </div>

      <div class="input-group mb-3">
      <div class="input-group-prepend">
      <span class="input-group-text">Grade</span>
      </div>
      <input type="text" class="form-control" id="grade" aria-label="grade" value="0"  onchange="UpdateAll();" >
      <div class="input-group-append">
      <span class="input-group-text" id="">%</span>
      </div>
      </div>

      <div class="input-group mb-3">
      <div class="input-group-prepend">
      <span class="input-group-text">Max Power</span>
      </div>
      <input type="text" class="form-control" id="pmax" aria-label="pmax" value="200"  onchange="UpdateAll();" >
      <div class="input-group-append">
      <span class="input-group-text" id="power_unit">Watts</span>
      </div>
      </div>

      <div class="input-group mb-3">
      <div class="input-group-prepend">
      <span class="input-group-text">Optimum Cadence</span>
      </div>
      <input type="text" class="form-control" id="PRopt" aria-label="PRopt" value="80" onchange="UpdateAll();" >
      <div class="input-group-append">
      <span class="input-group-text" id="PRopt_unit">rpm</span>
      </div>
      </div>
	  
	  
      <div class="input-group mb-3">
      <div class="input-group-prepend">
      <span class="input-group-text">Wheel Circumference</span>
      </div>
	  
	  <div class="dropdown">
	  <button class="btn btn-secondary btn dropdown-toggle" type="button" id="dropdownMenuButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
		Select
	  </button>
      <div class="dropdown-menu" aria-labelledby="dropdownMenuButton" id="wheel-list" onclick='UpdateAll();'>

	  </div>
	  </div>
	  
      <input type="text" class="form-control" id="circ" aria-label="circ" value="2.146" onchange="UpdateAll();" >
      <div class="input-group-append">
      <span class="input-group-text" id="wheel_unit">m</span>
      </div>
      </div>



	<div>
	<table  class="table .table-sm"  style="text-align: center;">
	<thead><th>Race Distance</th><th>Optimum Development (m)</th><th>Gear Ratio</th><th>Time</th></thead>
	<tbody id="tab-results">
    </tbody>
    <tfoot id="tab-footer"> </tfoot>
    </table>
	</div>
    
	<div id='vinf-plot-div'><!-- Plotly chart will be drawn inside this DIV --></div>
	
	<div id='dopt-plot-div'><!-- Plotly chart will be drawn inside this DIV --></div>
	
		


</div>
</div>





<!-- Google tag (gtag.js) -->
<!--
<script async src="https://www.googletagmanager.com/gtag/js?id=G-TSB5RJ1T0J"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-TSB5RJ1T0J');
</script>
-->

</body>
</html>
